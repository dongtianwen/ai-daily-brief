name: AI Daily Brief
# AI Daily Brief Bot - è‡ªåŠ¨ç”ŸæˆAIæŠ€æœ¯ç®€æŠ¥éŸ³é¢‘
# æ¯å¤©æ—©ä¸Š8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨æ‰§è¡Œï¼Œç”ŸæˆéŸ³é¢‘æ–‡ä»¶å¹¶éƒ¨ç½²åˆ°GitHub Pages
# ç‰ˆæœ¬: 1.0.1

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´0ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'  # UTCæ—¶é—´0ç‚¹ = åŒ—äº¬æ—¶é—´8ç‚¹
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  generate-brief:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file
        run: |
          echo "DEBUG=True" > .env
          echo "ZHIPUAI_API_KEY=${{ secrets.ZHIPUAI_API_KEY }}" >> .env

      - name: Run daily brief bot
        run: python main.py

      - name: Upload audio artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-brief-audio
          path: output/audio/
          retention-days: 7

      - name: Generate index.html for GitHub Pages
        run: |
          mkdir -p output/audio
          cat > output/audio/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AIæ¯æ—¥ç®€æŠ¥ - AI Daily Brief</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container {
                      background: white;
                      border-radius: 12px;
                      padding: 30px;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #333;
                      text-align: center;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      text-align: center;
                      color: #666;
                      margin-bottom: 30px;
                  }
                  .audio-list {
                      list-style: none;
                      padding: 0;
                  }
                  .audio-item {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 15px;
                      margin-bottom: 15px;
                      border-left: 4px solid #667eea;
                  }
                  .audio-title {
                      font-weight: bold;
                      color: #333;
                      margin-bottom: 10px;
                  }
                  audio {
                      width: 100%;
                      border-radius: 4px;
                  }
                  .download-link {
                      display: inline-block;
                      margin-top: 10px;
                      color: #667eea;
                      text-decoration: none;
                  }
                  .download-link:hover {
                      text-decoration: underline;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 30px;
                      color: #999;
                      font-size: 14px;
                  }
                  .no-audio {
                      text-align: center;
                      color: #999;
                      padding: 40px;
                      background: #f8f9fa;
                      border-radius: 8px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ¤– AIæ¯æ—¥ç®€æŠ¥</h1>
                  <p class="subtitle">æ¯å¤©æ—©ä¸Š8ç‚¹è‡ªåŠ¨ç”Ÿæˆçš„AIæŠ€æœ¯æ–°é—»è¯­éŸ³æ’­æŠ¥</p>
          EOF
          
          # æŸ¥æ‰¾æ‰€æœ‰mp3æ–‡ä»¶å¹¶æ·»åŠ åˆ°index.html
          mp3_files=$(find output/audio -name "*.mp3" -type f 2>/dev/null | sort -r)
          
          if [ -n "$mp3_files" ]; then
              echo "          <ul class=\"audio-list\">" >> output/audio/index.html
              counter=1
              for file in $mp3_files; do
                  filename=$(basename "$file")
                  # ä»æ–‡ä»¶åæå–æ—¥æœŸ (æ ¼å¼: daily_brief_YYYYMMDD_HHMMSS.mp3)
                  file_date=$(echo "$filename" | sed 's/daily_brief_\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)_.*/\1å¹´\2æœˆ\3æ—¥/')
                  file_time=$(echo "$filename" | sed 's/daily_brief_[0-9]\{8\}_\([0-9]\{2\}\)\([0-9]\{2\}\).*/\1:\2/')
                  if [ $counter -eq 1 ]; then
                      title="ğŸ“¢ æœ€æ–°AIæ¯æ—¥ç®€æŠ¥"
                  else
                      title="ğŸ“¢ AIæ¯æ—¥ç®€æŠ¥ #$counter"
                  fi
                  echo "              <li class=\"audio-item\">" >> output/audio/index.html
                  echo "                  <div class=\"audio-title\">$title</div>" >> output/audio/index.html
                  echo "                  <div style=\"color: #666; font-size: 14px; margin-bottom: 10px;\">ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š$file_date $file_time</div>" >> output/audio/index.html
                  echo "                  <audio controls>" >> output/audio/index.html
                  echo "                      <source src=\"$filename\" type=\"audio/mpeg\">" >> output/audio/index.html
                  echo "                      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚" >> output/audio/index.html
                  echo "                  </audio>" >> output/audio/index.html
                  echo "                  <br>" >> output/audio/index.html
                  echo "                  <a href=\"$filename\" download class=\"download-link\">â¬‡ï¸ ä¸‹è½½éŸ³é¢‘æ–‡ä»¶</a>" >> output/audio/index.html
                  echo "              </li>" >> output/audio/index.html
                  counter=$((counter + 1))
              done
              echo "          </ul>" >> output/audio/index.html
          else
              echo "          <div class=\"no-audio\">" >> output/audio/index.html
              echo "              <p>ğŸµ æš‚æ— éŸ³é¢‘æ–‡ä»¶</p>" >> output/audio/index.html
              echo "              <p>è¯·ç­‰å¾…æ˜å¤©æ—©ä¸Š8ç‚¹çš„è‡ªåŠ¨æ›´æ–°ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘workflowç”ŸæˆéŸ³é¢‘</p>" >> output/audio/index.html
              echo "          </div>" >> output/audio/index.html
          fi
          
          cat >> output/audio/index.html << 'EOF'
                  <div class="footer">
                      <p>ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | <a href="https://github.com/dongtianwen/ai-daily-brief">æŸ¥çœ‹æºç </a></p>
                      <p>æ›´æ–°æ—¶é—´ï¼šæ¯å¤©ä¸Šåˆ8:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-temp
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Merge with existing files
        run: |
          # å¦‚æœgh-pagesåˆ†æ”¯å­˜åœ¨ï¼Œå¤åˆ¶ç°æœ‰æ–‡ä»¶
          if [ -d "gh-pages-temp" ] && [ "$(ls -A gh-pages-temp/*.mp3 2>/dev/null)" ]; then
            echo "Found existing audio files, merging..."
            cp -n gh-pages-temp/*.mp3 output/audio/ 2>/dev/null || true
          fi
          # åˆ—å‡ºæ‰€æœ‰éŸ³é¢‘æ–‡ä»¶
          echo "Audio files in output/audio:"
          ls -la output/audio/*.mp3 2>/dev/null || echo "No mp3 files found"

      - name: Regenerate index.html with all audio files
        run: |
          # é‡æ–°ç”Ÿæˆindex.htmlï¼ŒåŒ…å«æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶
          cat > output/audio/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AIæ¯æ—¥ç®€æŠ¥ - AI Daily Brief</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container {
                      background: white;
                      border-radius: 12px;
                      padding: 30px;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #333;
                      text-align: center;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      text-align: center;
                      color: #666;
                      margin-bottom: 30px;
                  }
                  .audio-list {
                      list-style: none;
                      padding: 0;
                  }
                  .audio-item {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 15px;
                      margin-bottom: 15px;
                      border-left: 4px solid #667eea;
                  }
                  .audio-title {
                      font-weight: bold;
                      color: #333;
                      margin-bottom: 10px;
                  }
                  audio {
                      width: 100%;
                      border-radius: 4px;
                  }
                  .download-link {
                      display: inline-block;
                      margin-top: 10px;
                      color: #667eea;
                      text-decoration: none;
                  }
                  .download-link:hover {
                      text-decoration: underline;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 30px;
                      color: #999;
                      font-size: 14px;
                  }
                  .no-audio {
                      text-align: center;
                      color: #999;
                      padding: 40px;
                      background: #f8f9fa;
                      border-radius: 8px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ¤– AIæ¯æ—¥ç®€æŠ¥</h1>
                  <p class="subtitle">æ¯å¤©æ—©ä¸Š8ç‚¹è‡ªåŠ¨ç”Ÿæˆçš„AIæŠ€æœ¯æ–°é—»è¯­éŸ³æ’­æŠ¥</p>
          EOF
          
          # æŸ¥æ‰¾æ‰€æœ‰mp3æ–‡ä»¶å¹¶æ·»åŠ åˆ°index.html
          mp3_files=$(find output/audio -name "*.mp3" -type f 2>/dev/null | sort -r)
          
          if [ -n "$mp3_files" ]; then
              echo "          <ul class=\"audio-list\">" >> output/audio/index.html
              counter=1
              for file in $mp3_files; do
                  filename=$(basename "$file")
                  # ä»æ–‡ä»¶åæå–æ—¥æœŸ (æ ¼å¼: daily_brief_YYYYMMDD_HHMMSS.mp3)
                  file_date=$(echo "$filename" | sed 's/daily_brief_\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)_.*/\1å¹´\2æœˆ\3æ—¥/')
                  file_time=$(echo "$filename" | sed 's/daily_brief_[0-9]\{8\}_\([0-9]\{2\}\)\([0-9]\{2\}\).*/\1:\2/')
                  if [ $counter -eq 1 ]; then
                      title="ğŸ“¢ æœ€æ–°AIæ¯æ—¥ç®€æŠ¥"
                  else
                      title="ğŸ“¢ AIæ¯æ—¥ç®€æŠ¥ #$counter"
                  fi
                  echo "              <li class=\"audio-item\">" >> output/audio/index.html
                  echo "                  <div class=\"audio-title\">$title</div>" >> output/audio/index.html
                  echo "                  <div style=\"color: #666; font-size: 14px; margin-bottom: 10px;\">ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š$file_date $file_time</div>" >> output/audio/index.html
                  echo "                  <audio controls>" >> output/audio/index.html
                  echo "                      <source src=\"$filename\" type=\"audio/mpeg\">" >> output/audio/index.html
                  echo "                      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚" >> output/audio/index.html
                  echo "                  </audio>" >> output/audio/index.html
                  echo "                  <br>" >> output/audio/index.html
                  echo "                  <a href=\"$filename\" download class=\"download-link\">â¬‡ï¸ ä¸‹è½½éŸ³é¢‘æ–‡ä»¶</a>" >> output/audio/index.html
                  echo "              </li>" >> output/audio/index.html
                  counter=$((counter + 1))
              done
              echo "          </ul>" >> output/audio/index.html
          else
              echo "          <div class=\"no-audio\">" >> output/audio/index.html
              echo "              <p>ğŸµ æš‚æ— éŸ³é¢‘æ–‡ä»¶</p>" >> output/audio/index.html
              echo "              <p>è¯·ç­‰å¾…æ˜å¤©æ—©ä¸Š8ç‚¹çš„è‡ªåŠ¨æ›´æ–°ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘workflowç”ŸæˆéŸ³é¢‘</p>" >> output/audio/index.html
              echo "          </div>" >> output/audio/index.html
          fi
          
          cat >> output/audio/index.html << 'EOF'
                  <div class="footer">
                      <p>ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | <a href="https://github.com/dongtianwen/ai-daily-brief">æŸ¥çœ‹æºç </a></p>
                      <p>æ›´æ–°æ—¶é—´ï¼šæ¯å¤©ä¸Šåˆ8:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        if: success()
        id: deployment
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output/audio/
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
