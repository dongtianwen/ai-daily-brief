name: AI Daily Brief
# AI Daily Brief Bot - è‡ªåŠ¨ç”ŸæˆAIæŠ€æœ¯ç®€æŠ¥éŸ³é¢‘
# æ¯å¤©æ—©ä¸Š8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨æ‰§è¡Œï¼Œç”ŸæˆéŸ³é¢‘æ–‡ä»¶å¹¶éƒ¨ç½²åˆ°GitHub Pages
# ç‰ˆæœ¬: 1.0.1

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´0ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'  # UTCæ—¶é—´0ç‚¹ = åŒ—äº¬æ—¶é—´8ç‚¹
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  generate-brief:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file
        run: |
          echo "DEBUG=True" > .env
          echo "ZHIPUAI_API_KEY=${{ secrets.ZHIPUAI_API_KEY }}" >> .env

      - name: Run daily brief bot
        run: python main.py

      - name: Upload audio artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-brief-audio
          path: output/audio/
          retention-days: 7

      - name: Generate index.html for GitHub Pages
        run: |
          mkdir -p output/audio
          cat > output/audio/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AIæ¯æ—¥ç®€æŠ¥ - AI Daily Brief</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container {
                      background: white;
                      border-radius: 12px;
                      padding: 30px;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #333;
                      text-align: center;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      text-align: center;
                      color: #666;
                      margin-bottom: 30px;
                  }
                  .audio-list {
                      list-style: none;
                      padding: 0;
                  }
                  .audio-item {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 15px;
                      margin-bottom: 15px;
                      border-left: 4px solid #667eea;
                  }
                  .audio-title {
                      font-weight: bold;
                      color: #333;
                      margin-bottom: 10px;
                  }
                  audio {
                      width: 100%;
                      border-radius: 4px;
                  }
                  .download-link {
                      display: inline-block;
                      margin-top: 10px;
                      color: #667eea;
                      text-decoration: none;
                  }
                  .download-link:hover {
                      text-decoration: underline;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 30px;
                      color: #999;
                      font-size: 14px;
                  }
                  .no-audio {
                      text-align: center;
                      color: #999;
                      padding: 40px;
                      background: #f8f9fa;
                      border-radius: 8px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ¤– AIæ¯æ—¥ç®€æŠ¥</h1>
                  <p class="subtitle">æ¯å¤©æ—©ä¸Š8ç‚¹è‡ªåŠ¨ç”Ÿæˆçš„AIæŠ€æœ¯æ–°é—»è¯­éŸ³æ’­æŠ¥</p>
          EOF
          
          # æŸ¥æ‰¾æ‰€æœ‰mp3æ–‡ä»¶å¹¶æ·»åŠ åˆ°index.html
          mp3_files=$(find output/audio -name "*.mp3" -type f 2>/dev/null | sort -r)
          
          if [ -n "$mp3_files" ]; then
              echo "          <ul class=\"audio-list\">" >> output/audio/index.html
              counter=1
              for file in $mp3_files; do
                  filename=$(basename "$file")
                  # ä»æ–‡ä»¶åæå–æ—¥æœŸ (æ ¼å¼: daily_brief_YYYYMMDD_HHMMSS.mp3)
                  file_date=$(echo "$filename" | sed 's/daily_brief_\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)_.*/\1å¹´\2æœˆ\3æ—¥/')
                  file_time=$(echo "$filename" | sed 's/daily_brief_[0-9]\{8\}_\([0-9]\{2\}\)\([0-9]\{2\}\).*/\1:\2/')
                  if [ $counter -eq 1 ]; then
                      title="ğŸ“¢ æœ€æ–°AIæ¯æ—¥ç®€æŠ¥"
                  else
                      title="ğŸ“¢ AIæ¯æ—¥ç®€æŠ¥ #$counter"
                  fi
                  echo "              <li class=\"audio-item\">" >> output/audio/index.html
                  echo "                  <div class=\"audio-title\">$title</div>" >> output/audio/index.html
                  echo "                  <div style=\"color: #666; font-size: 14px; margin-bottom: 10px;\">ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š$file_date $file_time</div>" >> output/audio/index.html
                  echo "                  <audio controls>" >> output/audio/index.html
                  echo "                      <source src=\"$filename\" type=\"audio/mpeg\">" >> output/audio/index.html
                  echo "                      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚" >> output/audio/index.html
                  echo "                  </audio>" >> output/audio/index.html
                  echo "                  <br>" >> output/audio/index.html
                  echo "                  <a href=\"$filename\" download class=\"download-link\">â¬‡ï¸ ä¸‹è½½éŸ³é¢‘æ–‡ä»¶</a>" >> output/audio/index.html
                  echo "              </li>" >> output/audio/index.html
                  counter=$((counter + 1))
              done
              echo "          </ul>" >> output/audio/index.html
          else
              echo "          <div class=\"no-audio\">" >> output/audio/index.html
              echo "              <p>ğŸµ æš‚æ— éŸ³é¢‘æ–‡ä»¶</p>" >> output/audio/index.html
              echo "              <p>è¯·ç­‰å¾…æ˜å¤©æ—©ä¸Š8ç‚¹çš„è‡ªåŠ¨æ›´æ–°ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘workflowç”ŸæˆéŸ³é¢‘</p>" >> output/audio/index.html
              echo "          </div>" >> output/audio/index.html
          fi
          
          cat >> output/audio/index.html << 'EOF'
                  <div class="footer">
                      <p>ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | <a href="https://github.com/dongtianwen/ai-daily-brief">æŸ¥çœ‹æºç </a></p>
                      <p>æ›´æ–°æ—¶é—´ï¼šæ¯å¤©ä¸Šåˆ8:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-temp
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Merge with existing files
        run: |
          # å¦‚æœgh-pagesåˆ†æ”¯å­˜åœ¨ï¼Œå¤åˆ¶ç°æœ‰æ–‡ä»¶
          if [ -d "gh-pages-temp" ] && [ "$(ls -A gh-pages-temp/*.mp3 2>/dev/null)" ]; then
            echo "Found existing audio files, merging..."
            cp -n gh-pages-temp/*.mp3 output/audio/ 2>/dev/null || true
            cp -n gh-pages-temp/*.txt output/audio/ 2>/dev/null || true
          fi
          # åˆ—å‡ºæ‰€æœ‰éŸ³é¢‘æ–‡ä»¶
          echo "Audio files in output/audio:"
          ls -la output/audio/*.mp3 2>/dev/null || echo "No mp3 files found"
          echo "Text files in output/audio:"
          ls -la output/audio/*.txt 2>/dev/null || echo "No txt files found"

      - name: Regenerate index.html with all audio files
        run: |
          # é‡æ–°ç”Ÿæˆindex.htmlï¼ŒåŒ…å«æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶
          cat > output/audio/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AIæ¯æ—¥ç®€æŠ¥ - AI Daily Brief</title>
              <style>
                  :root {
                      --primary-color: #4f46e5;
                      --primary-hover: #4338ca;
                      --secondary-color: #64748b;
                      --success-color: #10b981;
                      --background-light: #f8fafc;
                      --text-primary: #1e293b;
                      --text-secondary: #64748b;
                      --border-color: #e2e8f0;
                  }
                  
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
                      font-size: 16px;
                      line-height: 1.6;
                      color: var(--text-primary);
                      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  
                  .container {
                      max-width: 900px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 16px;
                      padding: clamp(24px, 5vw, 48px);
                      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                                  0 2px 4px -1px rgba(0, 0, 0, 0.06);
                  }
                  
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                  }
                  
                  h1 {
                      font-size: clamp(1.5rem, 5vw, 2.5rem);
                      font-weight: 700;
                      color: var(--text-primary);
                      margin-bottom: 12px;
                      letter-spacing: -0.025em;
                  }
                  
                  .subtitle {
                      color: var(--text-secondary);
                      font-size: 1rem;
                  }
                  
                  .audio-list {
                      list-style: none;
                  }
                  
                  .audio-item {
                      background: var(--background-light);
                      border-radius: 12px;
                      padding: 24px;
                      margin-bottom: 20px;
                      border: 1px solid var(--border-color);
                      transition: all 0.3s ease;
                      animation: fadeIn 0.5s ease forwards;
                  }
                  
                  .audio-item:hover {
                      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                      transform: translateY(-2px);
                      border-color: var(--primary-color);
                  }
                  
                  .audio-header {
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin-bottom: 16px;
                  }
                  
                  .audio-title {
                      font-size: 1.125rem;
                      font-weight: 600;
                      color: var(--text-primary);
                      display: flex;
                      align-items: center;
                      gap: 8px;
                  }
                  
                  .time-badge {
                      display: inline-flex;
                      align-items: center;
                      gap: 4px;
                      padding: 6px 12px;
                      background: white;
                      border-radius: 20px;
                      font-size: 0.875rem;
                      color: var(--text-secondary);
                      border: 1px solid var(--border-color);
                  }
                  
                  audio {
                      width: 100%;
                      border-radius: 8px;
                      margin: 16px 0;
                  }
                  
                  .button-group {
                      display: flex;
                      gap: 12px;
                      flex-wrap: wrap;
                  }
                  
                  .text-toggle {
                      display: inline-flex;
                      align-items: center;
                      gap: 6px;
                      padding: 10px 20px;
                      background: var(--primary-color);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 0.875rem;
                      font-weight: 500;
                      transition: all 0.2s ease;
                      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
                  }
                  
                  .text-toggle:hover {
                      background: var(--primary-hover);
                      transform: translateY(-1px);
                      box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
                  }
                  
                  .download-link {
                      display: inline-flex;
                      align-items: center;
                      gap: 6px;
                      padding: 10px 20px;
                      color: var(--primary-color);
                      text-decoration: none;
                      border: 1px solid var(--primary-color);
                      border-radius: 8px;
                      font-size: 0.875rem;
                      font-weight: 500;
                      transition: all 0.2s ease;
                  }
                  
                  .download-link:hover {
                      background: var(--primary-color);
                      color: white;
                  }
                  
                  .text-content {
                      display: none;
                      max-height: 0;
                      overflow: hidden;
                      margin-top: 16px;
                      padding: 0 16px;
                      background: white;
                      border-radius: 8px;
                      border: 1px solid var(--border-color);
                      font-size: 0.9375rem;
                      line-height: 1.7;
                      color: var(--text-primary);
                      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
                      opacity: 0;
                  }
                  
                  .text-content.show {
                      display: block;
                      max-height: 2000px;
                      padding: 16px;
                      opacity: 1;
                  }
                  
                  .footer {
                      text-align: center;
                      margin-top: 48px;
                      padding-top: 24px;
                      border-top: 1px solid var(--border-color);
                      color: var(--text-secondary);
                      font-size: 0.875rem;
                  }
                  
                  .footer a {
                      color: var(--primary-color);
                      text-decoration: none;
                  }
                  
                  .footer a:hover {
                      text-decoration: underline;
                  }
                  
                  .no-audio {
                      text-align: center;
                      color: var(--text-secondary);
                      padding: 60px 40px;
                      background: var(--background-light);
                      border-radius: 12px;
                      border: 1px solid var(--border-color);
                  }
                  
                  @keyframes fadeIn {
                      from { opacity: 0; transform: translateY(10px); }
                      to { opacity: 1; transform: translateY(0); }
                  }
                  
                  @media (max-width: 768px) {
                      body {
                          padding: 10px;
                      }
                      
                      .container {
                          padding: 20px;
                          border-radius: 12px;
                      }
                      
                      .audio-header {
                          flex-direction: column;
                          align-items: flex-start;
                          gap: 12px;
                      }
                      
                      .button-group {
                          flex-direction: column;
                      }
                      
                      .text-toggle,
                      .download-link {
                          width: 100%;
                          justify-content: center;
                      }
                  }
                  
                  @media (max-width: 480px) {
                      .container {
                          padding: 16px;
                          border-radius: 8px;
                      }
                      
                      .audio-item {
                          padding: 16px;
                      }
                      
                      h1 {
                          font-size: 1.5rem;
                      }
                      
                      .audio-title {
                          font-size: 1rem;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ¤– AIæ¯æ—¥ç®€æŠ¥</h1>
                      <p class="subtitle">æ¯å¤©æ—©ä¸Š8ç‚¹è‡ªåŠ¨ç”Ÿæˆçš„AIæŠ€æœ¯æ–°é—»è¯­éŸ³æ’­æŠ¥</p>
                  </div>
          EOF
          
          # æŸ¥æ‰¾æ‰€æœ‰mp3æ–‡ä»¶å¹¶æ·»åŠ åˆ°index.html
          mp3_files=$(find output/audio -name "*.mp3" -type f 2>/dev/null | sort -r)
          
          if [ -n "$mp3_files" ]; then
              echo "          <ul class=\"audio-list\">" >> output/audio/index.html
              counter=1
              for file in $mp3_files; do
                  filename=$(basename "$file")
                  # ä»æ–‡ä»¶åæå–æ—¥æœŸ (æ ¼å¼: daily_brief_YYYYMMDD_HHMMSS.mp3)
                  file_date=$(echo "$filename" | sed 's/daily_brief_\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)_.*/\1å¹´\2æœˆ\3æ—¥/')
                  file_time=$(echo "$filename" | sed 's/daily_brief_[0-9]\{8\}_\([0-9]\{2\}\)\([0-9]\{2\}\).*/\1:\2/')
                  if [ $counter -eq 1 ]; then
                      title="ğŸ“¢ æœ€æ–°AIæ¯æ—¥ç®€æŠ¥"
                  else
                      title="ğŸ“¢ AIæ¯æ—¥ç®€æŠ¥ #$counter"
                  fi
                  
                  # æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„txtæ–‡ä»¶
                  txt_file="${file%.mp3}.txt"
                  has_text="false"
                  if [ -f "$txt_file" ]; then
                      has_text="true"
                  fi
                  
                  echo "              <li class=\"audio-item\">" >> output/audio/index.html
                  echo "                  <div class=\"audio-header\">" >> output/audio/index.html
                  echo "                      <div class=\"audio-title\">$title</div>" >> output/audio/index.html
                  echo "                      <div class=\"time-badge\">ğŸ“… $file_date $file_time</div>" >> output/audio/index.html
                  echo "                  </div>" >> output/audio/index.html
                  echo "                  <audio controls>" >> output/audio/index.html
                  echo "                      <source src=\"$filename\" type=\"audio/mpeg\">" >> output/audio/index.html
                  echo "                      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚" >> output/audio/index.html
                  echo "                  </audio>" >> output/audio/index.html
                  echo "                  <div class=\"button-group\">" >> output/audio/index.html
                  echo "                      <a href=\"$filename\" download class=\"download-link\">â¬‡ï¸ ä¸‹è½½éŸ³é¢‘</a>" >> output/audio/index.html
                  
                  # å¦‚æœæœ‰æ–‡å­—æ–‡ä»¶ï¼Œæ·»åŠ æ˜¾ç¤ºæ–‡å­—æŒ‰é’®
                  if [ "$has_text" = "true" ]; then
                      echo "                      <button class=\"text-toggle\" onclick=\"toggleText('$counter')\">ğŸ“– æŸ¥çœ‹æ–‡å­—å†…å®¹</button>" >> output/audio/index.html
                  fi
                  
                  echo "                  </div>" >> output/audio/index.html
                  
                  # å¦‚æœæœ‰æ–‡å­—æ–‡ä»¶ï¼Œæ·»åŠ æ–‡å­—å†…å®¹
                  if [ "$has_text" = "true" ]; then
                      echo "                  <div id=\"text-$counter\" class=\"text-content\">" >> output/audio/index.html
                      # è¯»å–txtæ–‡ä»¶å†…å®¹å¹¶è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
                      sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&#39;/g' "$txt_file" | sed 's/^/                      /' >> output/audio/index.html
                      echo "                  </div>" >> output/audio/index.html
                  fi
                  
                  echo "              </li>" >> output/audio/index.html
                  counter=$((counter + 1))
              done
              echo "          </ul>" >> output/audio/index.html
          else
              echo "          <div class=\"no-audio\">" >> output/audio/index.html
              echo "              <p>ğŸµ æš‚æ— éŸ³é¢‘æ–‡ä»¶</p>" >> output/audio/index.html
              echo "              <p>è¯·ç­‰å¾…æ˜å¤©æ—©ä¸Š8ç‚¹çš„è‡ªåŠ¨æ›´æ–°ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘workflowç”ŸæˆéŸ³é¢‘</p>" >> output/audio/index.html
              echo "          </div>" >> output/audio/index.html
          fi
          
          cat >> output/audio/index.html << 'EOF'
                  <div class="footer">
                      <p>ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | <a href="https://github.com/dongtianwen/ai-daily-brief">æŸ¥çœ‹æºç </a></p>
                      <p>æ›´æ–°æ—¶é—´ï¼šæ¯å¤©ä¸Šåˆ8:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰</p>
                  </div>
              </div>
              <script>
                  function toggleText(id) {
                      var textDiv = document.getElementById('text-' + id);
                      var button = event.target;
                      
                      if (textDiv.classList.contains('show')) {
                          textDiv.classList.remove('show');
                          button.textContent = 'ğŸ“– æŸ¥çœ‹æ–‡å­—å†…å®¹';
                      } else {
                          textDiv.classList.add('show');
                          button.textContent = 'ğŸ“• éšè—æ–‡å­—å†…å®¹';
                      }
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        if: success()
        id: deployment
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output/audio/
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
